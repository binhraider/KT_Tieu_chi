<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Backend H·ªì S∆° Khoa H·ªçc</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 2rem; }
        .container { max-width: 960px; }
        h2, h3 { border-bottom: 2px solid #0d6efd; padding-bottom: 0.5rem; margin-top: 2rem; }
        .work-entry {
            border: 1px solid #ccc;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-primary">Giao di·ªán Test Backend</h1>
        <p><strong>L∆∞u √Ω:</strong> Backend FastAPI c·ªßa b·∫°n ph·∫£i ƒëang ch·∫°y tr√™n <code>http://127.0.0.1:8000</code>.</p>
        
        <datalist id="journalOptions"></datalist>
        
        <h2>üöÄ Ch·ª©c nƒÉng: T·∫£i l√™n minh ch·ª©ng</h2>
        <form id="uploadForm" class="mb-5">
            <div class="card p-3">
                <div class="row align-items-end">
                    <div class="col-md-3 mb-3">
                        <label for="uploadUserId" class="form-label">ID Ng∆∞·ªùi d√πng</label>
                        <input type="number" class="form-control" id="uploadUserId" value="1" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="uploadDocType" class="form-label">Lo·∫°i minh ch·ª©ng</label>
                        <select id="uploadDocType" class="form-select">
                            <option value="NGOAI_NGU" selected>B·∫±ng Ngo·∫°i ng·ªØ</option>
                            <option value="BANG_TIEN_SI">B·∫±ng Ti·∫øn sƒ©</option>
                            <option value="KHAC">Gi·∫•y t·ªù kh√°c</option>
                        </select>
                    </div>
                    <div class="col-md-5 mb-3">
                        <label for="fileUpload" class="form-label">Ch·ªçn file</label>
                        <input class="form-control" type="file" id="fileUpload" required>
                    </div>
                </div>
                <div class="mt-2">
                     <button type="submit" class="btn btn-success">T·∫£i l√™n</button>
                </div>
                <div id="uploadResult" class="mt-3"></div>
            </div>
        </form>

        <h2>‚≠êÔ∏è T·∫°o v√† Ki·ªÉm tra H·ªì s∆° PGS</h2>
        <form id="profileForm">
            <div class="mb-4 p-3 bg-light border rounded">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="daoDucCheck" required>
                    <label class="form-check-label" for="daoDucCheck"><strong>X√°c nh·∫≠n:</strong> T√¥i kh√¥ng vi ph·∫°m ƒë·∫°o ƒë·ª©c nh√† gi√°o.</label>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3"><label for="thoiGianCongTac" class="form-label">TG C√¥ng t√°c (‚â• 6)</label><input type="number" class="form-control" id="thoiGianCongTac" value="6" required></div>
                <div class="col-md-4 mb-3"><label for="namSauTS" class="form-label">NƒÉm sau TS (‚â• 3)</label><input type="number" class="form-control" id="namSauTS" value="3" required></div>
                <div class="col-md-4 mb-3"><label for="gioGiangDay" class="form-label">Gi·ªù gi·∫£ng/nƒÉm (‚â• 275)</label><input type="number" class="form-control" id="gioGiangDay" value="275" required></div>
                <div class="col-md-6 mb-3"><label for="soThacSi" class="form-label">S·ªë ThS HD (‚â• 2)</label><input type="number" class="form-control" id="soThacSi" value="2" required></div>
                <div class="col-md-6 mb-3"><label for="soTienSi" class="form-label">S·ªë NCS HD (‚â• 1)</label><input type="number" class="form-control" id="soTienSi" value="1" required></div>
                 <div class="col-md-6 mb-3"><label for="soDeTaiBo" class="form-label">S·ªë ƒë·ªÅ t√†i c·∫•p B·ªô (‚â• 1)</label><input type="number" class="form-control" id="soDeTaiBo" value="1" required></div>
                 <div class="col-md-6 mb-3"><label for="soDeTaiCoSo" class="form-label">S·ªë ƒë·ªÅ t√†i c·∫•p C∆° s·ªü (‚â• 2)</label><input type="number" class="form-control" id="soDeTaiCoSo" value="2" required></div>
            </div>

            <h4 class="mt-4">Danh s√°ch c√¥ng tr√¨nh khoa h·ªçc (Bot s·∫Ω t·ª± ƒë·ªông ki·ªÉm tra)</h4>
            <div id="worksContainer"></div>
            <button type="button" class="btn btn-outline-secondary mt-2" id="addWorkBtn">Th√™m c√¥ng tr√¨nh</button>
            <hr>
            <button type="submit" class="btn btn-primary btn-lg mt-3">Ki·ªÉm tra H·ªì s∆° v√† Ch·∫°y Bot X√°c Minh</button>
        </form>

        <h3 class="mt-4">K·∫øt qu·∫£ Ki·ªÉm tra Ti√™u chu·∫©n</h3>
        <div id="checklistResultTable"><p class="text-muted">K·∫øt qu·∫£ ch·∫•m ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...</p></div>

        <h3 class="mt-4">K·∫øt qu·∫£ Bot X√°c Minh T·ª± ƒë·ªông</h3>
        <div id="verificationResultContainer"><p class="text-muted">K·∫øt qu·∫£ c·ªßa bot s·∫Ω hi·ªán ·ªü ƒë√¢y sau khi ki·ªÉm tra h·ªì s∆°...</p></div>
    </div>

    <template id="workTemplate">
        <div class="work-entry">
            <div class="row">
                <div class="col-md-4 mb-2">
                    <label class="form-label">Lo·∫°i c√¥ng tr√¨nh</label>
                    <select class="form-select loai-cong-trinh">
                        <option value="TAP_CHI" selected>B√†i b√°o T·∫°p ch√≠</option>
                        <optgroup label="S√°ch ph·ª•c v·ª• ƒë√†o t·∫°o">
                            <option value="SACH_CHUYEN_KHAO">S√°ch chuy√™n kh·∫£o</option>
                            <option value="SACH_GIAO_TRINH">Gi√°o tr√¨nh</option>
                            <option value="SACH_THAM_KHAO">S√°ch tham kh·∫£o</option>
                            <option value="SACH_HUONG_DAN">S√°ch h∆∞·ªõng d·∫´n / T·ª´ ƒëi·ªÉn</option>
                            <option value="CHUONG_SACH">Ch∆∞∆°ng s√°ch</option>
                        </optgroup>
                        <optgroup label="K·∫øt qu·∫£ ·ª©ng d·ª•ng KH&CN">
                            <option value="SANG_CHE">B·∫±ng ƒë·ªôc quy·ªÅn s√°ng ch·∫ø</option>
                            <option value="GIAI_PHAP_HUU_ICH">Gi·∫£i ph√°p h·ªØu √≠ch</option>
                        </optgroup>
                        <optgroup label="T√°c ph·∫©m ngh·ªá thu·∫≠t / TDTT">
                            <option value="GIAI_THUONG_QUOC_GIA">Gi·∫£i th∆∞·ªüng c·∫•p Qu·ªëc gia</option>
                            <option value="GIAI_THUONG_QUOC_TE">Gi·∫£i th∆∞·ªüng c·∫•p Qu·ªëc t·∫ø</option>
                        </optgroup>
                        <option value="BAI_BAO_THAY_THE">B√†i b√°o thay th·∫ø ƒë·ªÅ t√†i</option>
                    </select>
                </div>
                <div class="col-md-8 mb-2">
                    <label class="form-label">T√™n c√¥ng tr√¨nh / S√°ch / S√°ng ch·∫ø</label>
                    <input type="text" class="form-control ten-cong-trinh" value="Nghi√™n c·ª©u khoa h·ªçc ABC">
                </div>
                <div class="col-12 mb-2 journal-input-container">
                    <label class="form-label">T√™n T·∫°p ch√≠</label>
                    <input type="text" class="form-control ten-tap-chi" list="journalOptions" placeholder="G√µ ƒë·ªÉ t√¨m ki·∫øm trong CSDL...">
                </div>
                <div class="col-12 mb-2 evidence-upload-container" style="display: none;">
                    <label class="form-label">T·∫£i l√™n minh ch·ª©ng</label>
                    <input type="file" class="form-control evidence-file" accept=".pdf,.doc,.docx,.jpg,.png">
                </div>
                <div class="col-4 mb-2"><label class="form-label">Ng√†y xu·∫•t b·∫£n/c·∫•p</label><input type="date" class="form-control ngay-xuat-ban"></div>
                <div class="col-4 mb-2"><label class="form-label">S·ªë ƒë·ªìng t√°c gi·∫£</label><input type="number" class="form-control so-dong-tac-gia" value="1"></div>
                <div class="col-4 d-flex align-items-center pt-3"><div class="form-check"><input class="form-check-input is-tac-gia-chinh" type="checkbox" checked><label class="form-check-label">L√† t√°c gi·∫£ ch√≠nh?</label></div></div>
            </div>
            <button type="button" class="btn btn-danger btn-sm mt-2 remove-work-btn">X√≥a</button>
        </div>
    </template>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        
        // --- KHAI B√ÅO BI·∫æN ---
        const uploadForm = document.getElementById('uploadForm');
        const uploadResult = document.getElementById('uploadResult');
        const profileForm = document.getElementById('profileForm');
        const checklistResultTable = document.getElementById('checklistResultTable');
        const verificationResultContainer = document.getElementById('verificationResultContainer');
        const worksContainer = document.getElementById('worksContainer');
        const addWorkBtn = document.getElementById('addWorkBtn');
        const workTemplate = document.getElementById('workTemplate');
        const journalOptions = document.getElementById('journalOptions');
        let journalsLoaded = false;
        
        // --- H√ÄM HI·ªÇN TH·ªä TH√îNG B√ÅO UPLOAD ---
        function showUploadAlert(message, type = 'info') { /* ... */ }

        // --- S·ª∞ KI·ªÜN SUBMIT FORM UPLOAD ---
        uploadForm.addEventListener('submit', async (event) => { /* ... */ });

        // --- S·ª∞ KI·ªÜN SUBMIT FORM KI·ªÇM TRA H·ªí S∆† ---
        profileForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const submitButton = profileForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...`;

            const works = [];
            document.querySelectorAll('.work-entry').forEach(entry => {
                works.push({
                    loai_cong_trinh: entry.querySelector('.loai-cong-trinh').value,
                    ten_cong_trinh: entry.querySelector('.ten-cong-trinh').value,
                    ten_tap_chi: entry.querySelector('.ten-tap-chi').value,
                    ngay_xuat_ban: entry.querySelector('.ngay-xuat-ban').value,
                    is_tac_gia_chinh: entry.querySelector('.is-tac-gia-chinh').checked,
                    so_dong_tac_gia: parseInt(entry.querySelector('.so-dong-tac-gia').value)
                });
            });
            const profileData = {
                tieu_chuan_dao_duc_ok: document.getElementById('daoDucCheck').checked,
                thoi_gian_cong_tac: parseInt(document.getElementById('thoiGianCongTac').value),
                so_nam_sau_ts: parseInt(document.getElementById('namSauTS').value),
                so_gio_giang_chuan: parseInt(document.getElementById('gioGiangDay').value),
                so_hoc_vien_thac_si_huong_dan: parseInt(document.getElementById('soThacSi').value),
                so_ncs_tien_si_huong_dan: parseInt(document.getElementById('soTienSi').value),
                so_de_tai_cap_bo: parseInt(document.getElementById('soDeTaiBo').value),
                so_de_tai_cap_co_so: parseInt(document.getElementById('soDeTaiCoSo').value),
                works: works,
            };

            checklistResultTable.innerHTML = `<p class="text-muted">ƒêang x·ª≠ l√Ω...</p>`;
            verificationResultContainer.innerHTML = `<p class="text-muted">ƒêang ch·ªù bot ch·∫°y...</p>`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/check-progress/pgs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`L·ªói t·ª´ server: ${JSON.stringify(errorData)}`);
                }
                const result = await response.json();

                renderChecklist(result);
                renderVerificationResults(result.cong_trinh_da_xac_minh);

            } catch (error) {
                checklistResultTable.innerHTML = `<div class="alert alert-danger">L·ªói: ${error.message}.</div>`;
                verificationResultContainer.innerHTML = '';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Ki·ªÉm tra H·ªì s∆° v√† Ch·∫°y Bot X√°c Minh';
            }
        });

        // --- C√ÅC H√ÄM RENDER K·∫æT QU·∫¢ ---
        function renderChecklist(data) { /* ... */ }
        function renderVerificationResults(verifiedWorks) { /* ... */ }

        // ===================================================================
        // S·ª¨A ƒê·ªîI: LOGIC ·∫®N/HI·ªÜN √î NH·∫¨P LI·ªÜU
        // ===================================================================

        // S·ª≠ d·ª•ng event delegation ƒë·ªÉ l·∫Øng nghe s·ª± ki·ªán tr√™n to√†n b·ªô container
        // S·ª≠ d·ª•ng event delegation ƒë·ªÉ l·∫Øng nghe s·ª± ki·ªán tr√™n to√†n b·ªô container
    worksContainer.addEventListener('change', (event) => {
        // Ch·ªâ x·ª≠ l√Ω n·∫øu s·ª± ki·ªán ƒë·∫øn t·ª´ √¥ ch·ªçn c√≥ class "loai-cong-trinh"
        if (event.target.classList.contains('loai-cong-trinh')) {
            // T√¨m ph·∫ßn t·ª≠ .work-entry cha g·∫ßn nh·∫•t c·ªßa √¥ select v·ª´a thay ƒë·ªïi
            const workEntry = event.target.closest('.work-entry');
            // T√¨m container c·ªßa √¥ nh·∫≠p t·∫°p ch√≠ v√† √¥ t·∫£i file
            const journalInputContainer = workEntry.querySelector('.journal-input-container');
            const evidenceUploadContainer = workEntry.querySelector('.evidence-upload-container');

            if (event.target.value === 'TAP_CHI') {
                journalInputContainer.style.display = 'block'; // Hi·ªán √¥ nh·∫≠p t·∫°p ch√≠
                evidenceUploadContainer.style.display = 'none'; // ·∫®n √¥ t·∫£i file
            } else {
                journalInputContainer.style.display = 'none'; // ·∫®n √¥ nh·∫≠p t·∫°p ch√≠
                evidenceUploadContainer.style.display = 'block'; // Hi·ªán √¥ t·∫£i file
            }
        }
    });

        // --- C√ÅC H√ÄM TI·ªÜN √çCH KH√ÅC ---
        worksContainer.addEventListener('focusin', async (event) => { /* ... */ });
        
        function addWorkEntry() {
            const templateContent = workTemplate.content.cloneNode(true);
            const workEntry = templateContent.querySelector('.work-entry');
            workEntry.querySelector('.ngay-xuat-ban').value = new Date().toISOString().split('T')[0];
            worksContainer.appendChild(workEntry);
        }
        addWorkBtn.addEventListener('click', addWorkEntry);

        worksContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-work-btn')) {
                event.target.closest('.work-entry').remove();
            }
        });
        
        // --- D√ÅN L·∫†I TO√ÄN B·ªò C√ÅC H√ÄM KH√îNG ƒê·ªîI ƒê·ªÇ ƒê·∫¢M B·∫¢O ƒê·∫¶Y ƒê·ª¶ ---
        function showUploadAlert(message, type = 'info') {const alertHtml = `<div class="alert alert-${type}" role="alert">${message}</div>`; uploadResult.innerHTML = alertHtml;}
        uploadForm.addEventListener('submit', async (event) => {event.preventDefault(); uploadResult.innerHTML = ''; const submitButton = uploadForm.querySelector('button[type="submit"]'); submitButton.disabled = true; submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...`; const formData = new FormData(); formData.append('user_id', document.getElementById('uploadUserId').value); formData.append('document_type', document.getElementById('uploadDocType').value); formData.append('file', document.getElementById('fileUpload').files[0]); try { const response = await fetch(`${API_BASE_URL}/api/users/upload-document`, { method: 'POST', body: formData, }); const result = await response.json(); if (!response.ok) { throw new Error(result.detail || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server.'); } showUploadAlert(`<strong>Th√†nh c√¥ng!</strong> File ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°i: <code>${result.file_path}</code>`, 'success'); uploadForm.reset(); } catch (error) { console.error('L·ªói khi t·∫£i file:', error); showUploadAlert(`<strong>Th·∫•t b·∫°i!</strong> ${error.message}`, 'danger'); } finally { submitButton.disabled = false; submitButton.textContent = 'T·∫£i l√™n'; }});
        function renderChecklist(data) { const totalScoreHtml = data.tong_quan && data.tong_quan.total_score !== undefined ? `<strong>T·ªïng quan:</strong> T·ªïng ƒëi·ªÉm quy ƒë·ªïi ƒë·∫°t ƒë∆∞·ª£c l√† <strong>${data.tong_quan.total_score.toFixed(2)}</strong>.` : 'Kh√¥ng c√≥ th√¥ng tin t·ªïng ƒëi·ªÉm.'; let tableHtml = `<div class="alert alert-info">${totalScoreHtml}</div><table class="table table-bordered table-striped"><thead class="table-dark"><tr><th>Tr·∫°ng th√°i</th><th>Ti√™u ch√≠</th><th>Y√™u c·∫ßu</th><th>Th·ª±c t·∫ø</th></tr></thead><tbody>`; if (data.chi_tiet) { data.chi_tiet.forEach(item => { tableHtml += `<tr><td><span class="badge ${item.dat ? 'bg-success' : 'bg-danger'}">${item.dat ? 'ƒê·∫°t' : 'Ch∆∞a ƒë·∫°t'}</span></td><td>${item.tieu_chi}</td><td>${item.yeu_cau}</td><td>${item.thuc_te}</td></tr>`; }); } tableHtml += `</tbody></table>`; checklistResultTable.innerHTML = tableHtml; }
        function renderVerificationResults(verifiedWorks) { if (!verifiedWorks || verifiedWorks.length === 0) { verificationResultContainer.innerHTML = `<p class="text-muted">Kh√¥ng c√≥ c√¥ng tr√¨nh n√†o ƒë·ªÉ x√°c minh.</p>`; return; } let resultHtml = '<ul class="list-group">'; verifiedWorks.forEach(item => { const result = item.verification_result; const isSuccess = result.verified; const alertClass = isSuccess ? 'list-group-item-success' : 'list-group-item-warning'; const statusIcon = isSuccess ? '‚úÖ' : '‚ö†Ô∏è'; resultHtml += `<li class="list-group-item ${alertClass}"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${item.ten_cong_trinh}</h6><small>${statusIcon} ${result.status}</small></div><p class="mb-1 small">${result.message}</p></li>`; }); resultHtml += '</ul>'; verificationResultContainer.innerHTML = resultHtml; }
        worksContainer.addEventListener('focusin', async (event) => { if (event.target.classList.contains('ten-tap-chi') && !journalsLoaded) { try { const response = await fetch(`${API_BASE_URL}/api/journals`); if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch t·∫°p ch√≠'); const journals = await response.json(); let optionsHtml = ''; journals.forEach(journal => { optionsHtml += `<option value="${journal.name || journal.ten_tap_chi}"></option>`; }); journalOptions.innerHTML = optionsHtml; journalsLoaded = true; } catch (error) { console.error('L·ªói khi t·∫£i t·∫°p ch√≠:', error); } } });

        // Kh·ªüi t·∫°o trang v·ªõi m·ªôt c√¥ng tr√¨nh m·∫´u
        addWorkEntry();
    </script>
</body>
</html>